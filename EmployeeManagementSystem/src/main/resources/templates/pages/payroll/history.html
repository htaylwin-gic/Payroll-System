<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard-layout}">
<head>
    <title th:text="'Payroll History - ' + ${employee.full_name}"></title>
    <style>
        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .salary-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            justify-items: center;
        }

        .action-buttons .btn {
            min-width: 70px;
            width: 100%;
        }

        .month-filter {
            max-width: 200px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div layout:fragment="dashboard-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">Payroll History</h4>
                <p class="text-muted mb-0" th:text="'Employee: ' + ${employee.full_name}"></p>
            </div>
            <div>
                <a th:href="@{/payroll/calculate/{employeeId}(employeeId=${employee.id})}" 
                   class="btn btn-primary me-2">
                    <i class="fas fa-calculator me-2"></i> New Calculation
                </a>
                <a th:href="@{/payroll/manage}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Back to Payroll
                </a>
            </div>
        </div>

        <!-- Employee Summary -->
        <div class="summary-card">
            <div class="row">
                <div class="col-md-3">
                    <small class="opacity-75">Employee ID</small>
                    <h5 th:text="'EMP-' + ${employee.id}"></h5>
                </div>
                <div class="col-md-3">
                    <small class="opacity-75">Current Salary</small>
                    <h5 th:text="${employee.salary != null ? #numbers.formatDecimal(employee.salary, 0, 'COMMA', 2, 'POINT') + ' MMK' : '0.00 MMK'}"></h5>
                </div>
                <div class="col-md-3">
                    <small class="opacity-75">Total Payroll Records</small>
                    <h5 th:text="${payrolls.size()}">0</h5>
                </div>
                <div class="col-md-3">
                    <small class="opacity-75">Last Updated</small>
                    <h5 th:if="${payrolls.size() > 0}" 
                        th:text="${#temporals.format(payrolls[0]?.createdAt, 'dd MMM yyyy')}"></h5>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="monthFilter" class="form-label">Filter by Month</label>
                        <select id="monthFilter" class="form-select month-filter" onchange="filterByMonth()">
                            <option value="">All Months</option>
                            <option th:each="period : ${@employeeService.getDistinctMonthYears()}"
                                    th:value="${period}"
                                    th:text="${period}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-primary" onclick="exportHistory()">
                            <i class="fas fa-file-export me-2"></i> Export History
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payroll History Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover history-table">
                        <thead>
                            <tr>
                                <th>Month/Year</th>
                                <th>Basic Salary</th>
                                <th>Present Days</th>
                                <th>Deductions</th>
                                <th>Additions</th>
                                <th>Net Salary</th>
                                <th>Travel Fee</th>
                                <th>Total Payment</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="payroll : ${payrolls}" th:data-month="${payroll.monthYear}">
                                <td>
                                    <strong th:text="${payroll.monthYear}"></strong>
                                    <div class="text-muted" style="font-size: 0.8rem;">
                                        <span th:text="${payroll.createdAt}"></span>
                                    </div>
                                </td>
                                <td class="salary-cell" 
                                    th:text="${payroll.basicSalary != null ? #numbers.formatDecimal(payroll.basicSalary, 0, 'COMMA', 2, 'POINT') + ' MMK' : '0.00 MMK'}">
                                </td>
                                <td>
                                    <span th:text="${payroll.presentDays} + '/' + ${payroll.workingDays}"></span>
                                    <div class="text-muted" style="font-size: 0.8rem;">
                                        <span th:if="${payroll.leaveDays > 0}" 
                                              class="text-warning">Leave: <span th:text="${payroll.leaveDays}"></span></span>
                                        <span th:if="${payroll.lateDays > 0}" 
                                              class="text-danger">Late: <span th:text="${payroll.lateDays}"></span></span>
                                    </div>
                                </td>
                                <td class="salary-cell text-danger" 
                                    th:text="${#numbers.formatDecimal((payroll.leaveDeduction != null ? payroll.leaveDeduction : 0) + (payroll.lateDeduction != null ? payroll.lateDeduction : 0) + (payroll.incomeTax != null ? payroll.incomeTax : 0) + (payroll.loanReturn != null ? payroll.loanReturn : 0) + (payroll.ssc != null ? payroll.ssc : 0) + (payroll.companyTrip != null ? payroll.companyTrip : 0), 0, 'COMMA', 2, 'POINT') + ' MMK'}">
                                </td>
                                <td class="salary-cell text-success" 
                                    th:text="${#numbers.formatDecimal((payroll.allowance != null ? payroll.allowance : 0) + (payroll.overtime != null ? payroll.overtime : 0) + (payroll.bonus != null ? payroll.bonus : 0) + (payroll.home != null ? payroll.home : 0) + (payroll.businessTrip != null ? payroll.businessTrip : 0) + (payroll.continuedYear != null ? payroll.continuedYear : 0) + (payroll.homeTownVisit != null ? payroll.homeTownVisit : 0) + (payroll.manualAdjust != null ? payroll.manualAdjust : 0) + (payroll.attendancePerfect != null ? payroll.attendancePerfect : 0) + (payroll.exchangeBenefit != null ? payroll.exchangeBenefit : 0), 0, 'COMMA', 2, 'POINT') + ' MMK'}">
                                </td>
                                <td class="salary-cell">
                                    <strong 
                                        th:text="${payroll.netSalary != null ? #numbers.formatDecimal(payroll.netSalary, 0, 'COMMA', 2, 'POINT') + ' MMK' : '0.00 MMK'}">
                                    </strong>
                                </td>
                                <td class="salary-cell" 
                                    th:text="${payroll.travelFee != null ? #numbers.formatDecimal(payroll.travelFee, 0, 'COMMA', 2, 'POINT') + ' MMK' : '0.00 MMK'}">
                                </td>
                                <td class="salary-cell">
                                    <h6 class="mb-0 text-primary" 
                                        th:text="${payroll.totalPayment != null ? #numbers.formatDecimal(payroll.totalPayment, 0, 'COMMA', 2, 'POINT') + ' MMK' : '0.00 MMK'}">
                                    </h6>
                                </td>
                                <td>
                                    <span class="badge bg-success status-badge">Paid</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-info"
                                                onclick="viewDetails(this)"
                                                th:data-id="${payroll.id}"
                                                th:data-basic="${payroll.basicSalary}"
                                                th:data-leave="${payroll.leaveDeduction}"
                                                th:data-late="${payroll.lateDeduction}"
                                                th:data-tax="${payroll.incomeTax}"
                                                th:data-loan="${payroll.loanReturn}"
                                                th:data-ssc="${payroll.ssc}"
                                                th:data-companyTrip="${payroll.companyTrip}"
                                                th:data-allowance="${payroll.allowance}"
                                                th:data-overtime="${payroll.overtime}"
                                                th:data-bonus="${payroll.bonus}"
                                                th:data-home="${payroll.home}"
                                                th:data-businessTrip="${payroll.businessTrip}"
                                                th:data-net="${payroll.netSalary}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning mb-1" 
                                                th:data-id="${payroll.id}"
                                                onclick="editPayroll(this.getAttribute('data-id'))">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger mb-1" 
                                                th:data-id="${payroll.id}"
                                                onclick="deletePayroll(this.getAttribute('data-id'), '${payroll.monthYear}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                th:data-id="${payroll.id}"
                                                onclick="downloadSlip(this.getAttribute('data-id'))">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${payrolls.empty}">
                                <td colspan="10" class="text-center py-4">
                                    <i class="fas fa-file-invoice-dollar fa-2x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Payroll Records Found</h5>
                                    <p class="text-muted">Start by creating a payroll calculation for this employee</p>
                                    <a th:href="@{/payroll/calculate/{employeeId}(employeeId=${employee.id})}" 
                                       class="btn btn-primary">
                                        <i class="fas fa-calculator me-2"></i> Create First Payroll
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed View (Hidden by default) -->
        <div class="card mt-4" id="detailedView" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">Detailed Payroll Breakdown</h5>
            </div>
            <div class="card-body" id="detailedContent">
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Total Paid</h6>
                        <h3 class="text-success">
                            <span th:text="${#numbers.formatDecimal(totalPaidAmount, 0, 'COMMA', 2, 'POINT') + ' MMK'}">0.00 MMK</span>
                        </h3>
                        <p class="text-muted mb-0">Total payments made</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Average Monthly</h6>
                        <h3 class="text-primary">
                            <span th:text="${#numbers.formatDecimal(averageMonthlyAmount, 0, 'COMMA', 2, 'POINT') + ' MMK'}">0.00 MMK</span>
                        </h3>
                        <p class="text-muted mb-0">Average monthly payment</p>
                    </div>
                </div>
            </div>
        </div>

    <th:block layout:fragment="scripts">
        <script>
            let currentPayrollId = null;

            function filterByMonth() {
                const selectedMonth = document.getElementById('monthFilter').value;
                const rows = document.querySelectorAll('.history-table tbody tr[data-month]');
                
                rows.forEach(row => {
                    if (!selectedMonth || row.dataset.month === selectedMonth) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            function formatMMK(value) {
                return (value ? Number(value).toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) : '0.00') + ' MMK';
            }

            function viewDetails(button) {
                const payrollId = button.dataset.id;
                const detailedView = document.getElementById('detailedView');
                const contentDiv = document.getElementById('detailedContent');

                // üîÅ Toggle OFF
                if (currentPayrollId === payrollId && detailedView.style.display === 'block') {
                    detailedView.style.display = 'none';
                    currentPayrollId = null;
                    return;
                }

                currentPayrollId = payrollId;
                const d = button.dataset;

                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Deductions Breakdown:</h6>
                            <ul class="list-unstyled">
                                <li>Leave Deduction: ${formatMMK(d.leave)}</li>
                                <li>Late Deduction: ${formatMMK(d.late)}</li>
                                <li>Income Tax: ${formatMMK(d.tax)}</li>
                                <li>Loan Return: ${formatMMK(d.loan)}</li>
                                <li>SSC: ${formatMMK(d.ssc)}</li>
                                <li>Company Trip: ${formatMMK(d.companyTrip)}</li>
                            </ul>
                        </div>

                        <div class="col-md-6">
                            <h6>Additions Breakdown:</h6>
                            <ul class="list-unstyled">
                                <li>Allowance: ${formatMMK(d.allowance)}</li>
                                <li>Overtime: ${formatMMK(d.overtime)}</li>
                                <li>Bonus: ${formatMMK(d.bonus)}</li>
                                <li>Home Allowance: ${formatMMK(d.home)}</li>
                                <li>Business Trip: ${formatMMK(d.businessTrip)}</li>
                            </ul>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <strong>Basic Salary:</strong>
                        <span>${formatMMK(d.basic)}</span>
                    </div>

                    <div class="d-flex justify-content-between mt-2">
                        <h5>Net Salary:</h5>
                        <h5 class="text-primary">${formatMMK(d.net)}</h5>
                    </div>
                `;

                contentDiv.innerHTML = content;
                detailedView.style.display = 'block';

                detailedView.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }


            function editPayroll(payrollId) {
                if (confirm('Edit this payroll record?')) {
                    window.location.href = `/payroll/edit/${payrollId}`;
                }
            }

            function deletePayroll(payrollId, monthYear) {
                if (confirm(`Are you sure you want to delete payroll record for ${monthYear}? This action cannot be undone.`)) {
                    window.location.href = `/payroll/delete/${payrollId}`;
                }
            }

            function downloadSlip(payrollId) {
                // alert(`Downloading payslip for record ${payrollId}`);
                window.location.href = `/payroll/download-slip/${payrollId}`;
            }

            function exportHistory() {
                // alert('Export functionality would generate a CSV/Excel file of all payroll history.');
                const pathParts = window.location.pathname.split('/');
                    const employeeId = pathParts[pathParts.length - 1];
                    
                    window.location.href = '/payroll/export-history/' + employeeId;
            }
        </script>
    </th:block>
</body>
</html>