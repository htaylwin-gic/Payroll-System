<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard-layout}">
<head>
    <title>Salary Summary</title>
    <style>
        .summary-card {
            border: none;
            border-radius: 10px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .department-card {
            border-left: 5px solid;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .salary-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .chart-container {
            height: 300px;
            position: relative;
            width: 100%;
        }
        .employee-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }
        .mmk-currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #28a745;
        }
        .dept-it { background-color: #667eea; color: white; }
        .dept-hr { background-color: #28a745; color: white; }
        .dept-technical { background-color: #ffc107; color: #212529; }
        .dept-design { background-color: #17a2b8; color: white; }
        .dept-finance { background-color: #6c757d; color: white; }
        .dept-sales { background-color: #fd7e14; color: white; }
        .dept-marketing { background-color: #20c997; color: white; }
        .dept-operations { background-color: #e83e8c; color: white; }
        .dept-customer-support { background-color: #6610f2; color: white; }
        .dept-other { background-color: #343a40; color: white; }
        
        @media print {
            .btn, .quick-actions, .input-group, .navbar, .sidebar {
                display: none !important;
            }
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div layout:fragment="dashboard-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">Salary Summary & Analytics</h4>
                <p class="text-muted mb-0">Comprehensive salary analysis across the organization</p>
            </div>
            <div>
                <a th:href="@{/status}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-2"></i> Back to Status
                </a>
                <button class="btn btn-primary me-2" onclick="window.print()">
                    <i class="fas fa-print me-2"></i> Print Report
                </button>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-primary">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Total Employees</h5>
                            <h2 class="text-white" th:text="${totalEmployees}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-users summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            <span th:text="${activeEmployees}">0</span> active employees
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-success">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Monthly Salary</h5>
                            <h2 class="text-white" th:text="${#numbers.formatDecimal(totalMonthlySalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-money-bill-wave summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">Total monthly payroll</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-warning">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Average Salary</h5>
                            <h2 class="text-white" th:text="${#numbers.formatDecimal(averageSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-chart-line summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">Per employee per month</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-info">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Active Employees</h5>
                            <h2 class="text-white" th:text="${activeEmployees}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-check summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            <span th:text="${totalEmployees > 0 ? #numbers.formatDecimal((activeEmployees * 1.0 / totalEmployees * 100), 1, 1) : 0}">0</span>% of workforce
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Department-wise Salary Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="salaryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Department Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="deptChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Department Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div th:each="dept : ${departmentStats}" class="col-md-4 mb-3">
                                <div class="department-card" 
                                    th:style="'border-left-color: ' + 
                                    (dept.key == 'IT' ? '#667eea' : 
                                    (dept.key == 'HR' ? '#28a745' : 
                                    (dept.key == 'Technical' ? '#ffc107' : 
                                    (dept.key == 'Design' ? '#17a2b8' : 
                                    (dept.key == 'Finance' ? '#6c757d' :
                                    (dept.key == 'Sales' ? '#fd7e14' :
                                    (dept.key == 'Marketing' ? '#20c997' :
                                    (dept.key == 'Operations' ? '#e83e8c' :
                                    (dept.key == 'Customer Support' ? '#6610f2' : '#343a40')))))))))">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold" th:text="${dept.key}">Dept</h6>
                                        <span class="badge bg-primary" th:text="${dept.value} + ' employees'">0</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted" th:text="${sectionPercentages.get(dept.key)} + '% of total'"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Salary List -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Employee Salary Details</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search employees..." id="employeeSearch">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="salaryTable">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Basic Salary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="emp : ${allEmployees}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="employee-avatar me-3">
                                            <span th:text="${emp.full_name != null ? emp.full_name.substring(0,1).toUpperCase() : ''}"></span>
                                        </div>
                                        <div>
                                            <div th:text="${emp.full_name}" class="fw-bold"></div>
                                            <small class="text-muted" th:text="'EMP-' + ${emp.id}"></small>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${emp.position}"></td>
                                <td>
                                    <span th:if="${emp.department == 'IT'}" class="badge dept-it" th:text="${emp.department}">IT</span>
                                    <span th:if="${emp.department == 'HR'}" class="badge dept-hr" th:text="${emp.department}">HR</span>
                                    <span th:if="${emp.department == 'Technical'}" class="badge dept-technical" th:text="${emp.department}">Technical</span>
                                    <span th:if="${emp.department == 'Design'}" class="badge dept-design" th:text="${emp.department}">Design</span>
                                    <span th:if="${emp.department == 'Finance'}" class="badge dept-finance" th:text="${emp.department}">Finance</span>
                                    <span th:if="${emp.department == 'Sales'}" class="badge dept-sales" th:text="${emp.department}">Sales</span>
                                    <span th:if="${emp.department == 'Marketing'}" class="badge dept-marketing" th:text="${emp.department}">Marketing</span>
                                    <span th:if="${emp.department == 'Operations'}" class="badge dept-operations" th:text="${emp.department}">Operations</span>
                                    <span th:if="${emp.department == 'Customer Support'}" class="badge dept-customer-support" th:text="${emp.department}">Customer Support</span>
                                    <span th:if="${emp.department != 'IT' and emp.department != 'HR' and emp.department != 'Technical' and emp.department != 'Design' and emp.department != 'Finance' and emp.department != 'Sales' and emp.department != 'Marketing' and emp.department != 'Operations' and emp.department != 'Customer Support'}" 
                                        class="badge dept-other" th:text="${emp.department}">Other</span>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="${emp.status == 'Active'} ? 'bg-success' : 'bg-danger'"
                                        th:text="${emp.status ?: 'Active'}">
                                    </span>
                                </td>
                                <td class="salary-cell">
                                    <span th:if="${emp.salary != null and emp.salary > 0}" class="mmk-currency">
                                        <span th:text="${#numbers.formatDecimal(emp.salary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                    <span th:unless="${emp.salary != null and emp.salary > 0}" class="text-muted">Not set</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/employees/edit/{id}(id=${emp.id})}" 
                                        class="btn btn-outline-warning" title="Edit Employee">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!--Show total count -->
            <div class="card-footer text-muted py-2">
                <small>Total <span th:text="${#lists.size(allEmployees)}"></span> employees</small>
            </div>
        </div>
        
        <!-- Salary Statistics -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Salary Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <small class="text-muted">Highest Salary</small>
                                <p class="mb-0 fw-bold mmk-currency" 
                                   th:text="${#numbers.formatDecimal(highestSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</p>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted">Lowest Salary</small>
                                <p class="mb-0 fw-bold mmk-currency" 
                                   th:text="${#numbers.formatDecimal(lowestSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a th:href="@{/payroll/manage}" class="btn btn-outline-primary">
                                <i class="fas fa-calculator me-2"></i> Go to Payroll Management
                            </a>
                            <a th:href="@{/employees/manage}" class="btn btn-outline-success border">
                                <i class="fas fa-users me-2"></i> Manage Employees
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script th:inline="javascript">
        /*<![CDATA[*/
            $(document).ready(function() {
            // Live search functionality
            $("#employeeSearch").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("#salaryTable tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const deptStats = /*[[${departmentStats}]]*/ {}; // Counts for Pie Chart
            const deptSalaries = /*[[${deptSalaryDistribution}]]*/ {}; // Totals for Bar Chart
            const deptPercentages = /*[[${sectionPercentages}]]*/ {};
            
            const departments = Object.keys(deptStats);
            const employeeCounts = Object.values(deptStats);
            const totalSalaries = departments.map(dept => deptSalaries[dept] || 0);

            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#667eea', '#28a745', '#ffc107', '#17a2b8', '#6c757d', '#fd7e14', '#20c997', '#e83e8c', '#6610f2', '#343a40'];
            
            // Department-wise Salary Distribution (Bar Chart)
            const salaryCtx = document.getElementById('salaryChart').getContext('2d');
                new Chart(salaryCtx, {
                    type: 'bar',
                    data: {
                        labels: departments,
                        datasets: [{
                            label: 'Total Salary (MMK)',
                            data: totalSalaries, 
                            backgroundColor: colors,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() + ' MMK' } }
                        }
                    }
                });

            // Department Distribution (Pie Chart)
           const deptCtx = document.getElementById('deptChart').getContext('2d');
        new Chart(deptCtx, {
            type: 'pie',
            data: {
                labels: departments.map(d => `${d} (${deptPercentages[d]}%)`),
                datasets: [{
                    data: employeeCounts, // Using actual counts from departmentStats
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        }); 
        });
        /*]]>*/
    </script>
    </th:block>
</body>
</html>