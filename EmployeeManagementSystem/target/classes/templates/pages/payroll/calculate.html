<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard-layout}">
<head>
    <title>Calculate Payroll</title>
    <style>
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        .calculation-box {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .deduction-amount {
            color: #dc3545;
            font-weight: bold;
        }
        .addition-amount {
            color: #28a745;
            font-weight: bold;
        }
        .employee-info {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .readonly-field {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .amount-display {
            font-size: 1.1rem;
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
    <div layout:fragment="dashboard-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">Calculate Payroll</h4>
                <p class="text-muted mb-0" th:text="'For: ' + ${employee.full_name}"></p>
            </div>
            <div>
                <a th:href="@{/payroll/manage}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Back to Payroll
                </a>
            </div>
        </div>

        <!-- Employee Information -->
        <div class="employee-info">
            <div class="row">
                <div class="col-md-2">
                    <small class="text-muted">Employee ID</small>
                    <p class="mb-0 fw-bold" th:text="'EMP-' + ${employee.id}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Band Level</small>
                    <p class="mb-0 fw-bold" id="employeeBandLevel" th:text="${employee.bandLevel}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Basic Salary</small>
                    <p class="mb-0 fw-bold" id="bandBasicSalary">0 MMK</p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Position</small>
                    <p class="mb-0" th:text="${employee.position}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Department</small>
                    <p class="mb-0" th:text="${employee.department}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Transportation Fee</small>
                    <p class="mb-0 fw-bold" id="employeeTransportationFeeText">
                        <span th:text="${employee.transportationFee != null ? #numbers.formatDecimal(employee.transportationFee, 0, 'COMMA', 2, 'POINT') : 0}"></span> MMK/day
                    </p>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-2">
                    <small class="text-muted">Start Date</small>
                    <p class="mb-0" th:text="${employee.startDate}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Education</small>
                    <p class="mb-0" id="employeeEducationLevel" th:text="${employee.educationLevel}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">PBC Grade</small>
                    <p class="mb-0" id="employeeEvaluationGrade" th:text="${employee.evaluationGrade}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Japanese JLPT</small>
                    <p class="mb-0" id="employeeJapaneseLevel" th:text="${employee.japaneseLevel}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Japanese NAT</small>
                    <p class="mb-0" id="employeeJapaneseNatTest" th:text="${employee.japaneseNatTest}"></p>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">English Level</small>
                    <p class="mb-0" id="employeeEnglishLevel" th:text="${employee.englishLevel}"></p>
                </div>
            </div>
        </div>

        <!-- Hidden field for employee transportation fee -->
        <input type="hidden" id="employeeTransportationFee" th:value="${employee.transportationFee}">

        <!-- Payroll Calculation Form -->
        <form th:action="@{/payroll/calculate}" method="post" th:object="${payrollRequest}">
            <input type="hidden" th:field="*{employeeId}" th:value="${employee.id}">
            <input type="hidden" id="bandLevel" th:value="${employee.bandLevel}">
            
            <!-- 1. Basic Information -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-calendar-alt me-2"></i>Basic Information
                </h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="monthYear" class="form-label">Month/Year *</label>
                        <input type="text" 
                               class="form-control" 
                               id="monthYear" 
                               th:field="*{monthYear}"
                               placeholder="e.g., Nov,2025"
                               required>
                        <div class="form-text">Format: MMM,yyyy (e.g., Jan,2024)</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="workingDays" class="form-label">Working Days *</label>
                        <input type="number" 
                               class="form-control" 
                               id="workingDays" 
                               th:field="*{workingDays}"
                               min="1" max="31"
                               required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="calculation-box">
                            <small class="text-muted">Basic Salary (based on Band)</small>
                            <h6 class="mb-0" id="displayBasicSalary">0 MMK</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Attendance Details -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-calendar-check me-2"></i>Attendance Details
                </h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="leaveDays" class="form-label">Leave Days</label>
                        <input type="number" 
                               class="form-control" 
                               id="leaveDays" 
                               th:field="*{leaveDays}"
                               min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lateDays" class="form-label">Late Days</label>
                        <input type="number" 
                               class="form-control" 
                               id="lateDays" 
                               th:field="*{lateDays}"
                               min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="presentDays" class="form-label">Present Days</label>
                        <input type="number" 
                               class="form-control readonly-field" 
                               id="presentDays" 
                               th:field="*{presentDays}"
                               readonly>
                        <div class="form-text">Auto-calculated: Working Days - Leave Days</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="overtimeHours" class="form-label">Overtime Hours</label>
                        <input type="number" 
                               class="form-control" 
                               id="overtimeHours" 
                               th:field="*{overtimeHours}"
                               min="0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="calculation-box">
                            <small class="text-muted">Overtime Amount</small>
                            <h4 class="mb-0 addition-amount" id="overtimeAmountDisplay">0 MMK</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Service Years & Experience -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-briefcase me-2"></i>Service Years & Experience
                </h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="myanmarYears" class="form-label">Myanmar Service Years</label>
                        <input type="number" 
                               class="form-control" 
                               id="myanmarYears" 
                               th:field="*{myanmarYears}"
                               min="0" max="6">
                        <div class="form-text">1-5 years: 15K/year, 6+ years: 90K fixed</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="gicjpYears" class="form-label">GICJP Service Years</label>
                        <input type="number" 
                               class="form-control" 
                               id="gicjpYears" 
                               th:field="*{gicjpYears}"
                               min="0" max="6">
                        <div class="form-text">1-5 years: 50K/year, 6+ years: 300K fixed</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="calculation-box">
                            <small class="text-muted">Service Allowance</small>
                            <h4 class="mb-0 addition-amount" id="serviceAllowanceDisplay">0 MMK</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Assignment & Management -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-users me-2"></i>Assignment & Management
                </h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="assignmentLevel" class="form-label">Assignment Level</label>
                        <select class="form-control addition-amount" 
                                id="assignmentLevel" 
                                th:field="*{assignmentLevel}">
                            <option value="None">None</option>
                            <option value="Sub TL" th:selected="${employee.assignmentLevel == 'Sub TL'}">Sub TL (+100,000)</option>
                            <option value="TL" th:selected="${employee.assignmentLevel == 'TL'}">TL (+200,000)</option>
                            <option value="PL" th:selected="${employee.assignmentLevel == 'PL'}">PL (+200,000)</option>
                            <option value="Senior PL" th:selected="${employee.assignmentLevel == 'Senior PL'}">Senior PL (+300,000)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="managementLevel" class="form-label">Management Level</label>
                        <select class="form-control addition-amount" 
                                id="managementLevel" 
                                th:field="*{managementLevel}">
                            <option value="None">None</option>
                            <option value="Sub Leader" th:selected="${employee.managementLevel == 'Sub Leader'}">Sub Leader (+500,000)</option>
                            <option value="Leader" th:selected="${employee.managementLevel == 'Leader'}">Leader (+600,000)</option>
                            <option value="Sub Manager" th:selected="${employee.managementLevel == 'Sub Manager'}">Sub Manager (+700,000)</option>
                            <option value="Manager" th:selected="${employee.managementLevel == 'Manager'}">Manager (+1,100,000)</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="calculation-box">
                            <small class="text-muted">Management & Assignment Allowance</small>
                            <h4 class="mb-0 addition-amount" id="managementAssignmentAllowanceDisplay">0 MMK</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Basic Allowance Details (Auto-populated from employee's Language Skill Information) -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-money-bill-wave me-2"></i>Basic Allowance Details
                </h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="educationAllowance" class="form-label">Education</label>
                        <select class="form-control addition-amount" 
                                id="educationAllowance" 
                                th:field="*{educationAllowance}">
                            <option value="0">-</option>
                            <option value="30000" th:selected="${employee.educationLevel == 'Diploma' or employee.educationLevel == 'FE Passer'}">
                                Diploma/FE Passer (+30,000)
                            </option>
                            <option value="50000" th:selected="${employee.educationLevel == 'Master'}">
                                Master (+50,000)
                            </option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="evaluationAllowance" class="form-label">Evaluation (PBC)</label>
                        <select class="form-control addition-amount" 
                                id="evaluationAllowance" 
                                th:field="*{evaluationAllowance}">
                            <option value="0">-</option>
                            <option value="10000" th:selected="${employee.evaluationGrade == 'C'}">C (+10,000)</option>
                            <option value="50000" th:selected="${employee.evaluationGrade == 'B'}">B (+50,000)</option>
                            <option value="100000" th:selected="${employee.evaluationGrade == 'A'}">A (+100,000)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="japaneseJlptAllowance" class="form-label">Japanese JLPT</label>
                        <select class="form-control addition-amount" 
                                id="japaneseJlptAllowance" 
                                th:field="*{japaneseJlptAllowance}">
                            <option value="0">-</option>
                            <option value="40000" th:selected="${employee.japaneseLevel == 'N3'}">N3 (+40,000)</option>
                            <option value="150000" th:selected="${employee.japaneseLevel == 'N2'}">N2 (+150,000)</option>
                            <option value="300000" th:selected="${employee.japaneseLevel == 'N1'}">N1 (+300,000)</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="japaneseNatAllowance" class="form-label">Japanese NAT Test</label>
                        <select class="form-control addition-amount" 
                                id="japaneseNatAllowance" 
                                th:field="*{japaneseNatAllowance}">
                            <option value="0">-</option>
                            <option value="20000" th:selected="${employee.japaneseNatTest == 'N3'}">N3 (+20,000)</option>
                            <option value="75000" th:selected="${employee.japaneseNatTest == 'N2'}">N2 (+75,000)</option>
                            <option value="150000" th:selected="${employee.japaneseNatTest == 'N1'}">N1 (+150,000)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="englishAllowance" class="form-label">English</label>
                        <select class="form-control addition-amount" 
                                id="englishAllowance" 
                                th:field="*{englishAllowance}">
                            <option value="0">-</option>
                            <option value="50000" th:selected="${employee.englishLevel == 'TOEIC 600+/TOEFL 505+/IELTS 5.5+'}">
                                TOEIC 600+/TOEFL 505+/IELTS 5.5+ (+50,000)
                            </option>
                            <option value="100000" th:selected="${employee.englishLevel == 'TOEIC 730+/TOEFL 550+/IELTS 6.5+'}">
                                TOEIC 730+/TOEFL 550+/IELTS 6.5+ (+100,000)
                            </option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="calculation-box">
                            <small class="text-muted">Total Basic Allowance</small>
                            <h4 class="mb-0 addition-amount" id="totalBasicAllowanceDisplay">0 MMK</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Deductions -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-minus-circle me-2 text-danger"></i>Deductions
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="leaveDeduction" class="form-label">Leave Deduction</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control deduction-amount readonly-field" 
                                   id="leaveDeduction" 
                                   th:field="*{leaveDeduction}"
                                   step="1000"
                                   min="0"
                                   readonly>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="lateDeduction" class="form-label">Late Deduction</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control deduction-amount readonly-field" 
                                   id="lateDeduction" 
                                   th:field="*{lateDeduction}"
                                   step="500"
                                   min="0"
                                   readonly>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="incomeTax" class="form-label">Income Tax</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control deduction-amount" 
                                   id="incomeTax" 
                                   th:field="*{incomeTax}"
                                   step="1000"
                                   min="0">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="loanReturn" class="form-label">Loan Return</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control deduction-amount" 
                                   id="loanReturn" 
                                   th:field="*{loanReturn}"
                                   step="1000"
                                   min="0">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="ssc" class="form-label">SSC Contribution</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control deduction-amount" 
                                   id="ssc" 
                                   th:field="*{ssc}"
                                   step="1000"
                                   min="0">
                        </div>
                        <div class="form-text">Depends on salary</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="companyTrip" class="form-label">Company Trip</label>
                        <select class="form-control deduction-amount" 
                                id="companyTrip" 
                                th:field="*{companyTrip}">
                            <option value="0">None</option>
                            <option value="10000">10,000 MMK</option>
                            <option value="20000">20,000 MMK</option>
                            <option value="30000">30,000 MMK</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="calculation-box">
                            <small class="text-muted">Total Deductions</small>
                            <h4 class="mb-0 deduction-amount" id="totalDeductionsDisplay">0 MMK</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. Additions & Allowances -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-plus-circle me-2 text-success"></i>Additions & Allowances
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="bonus" class="form-label">Bonus</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control addition-amount" 
                                   id="bonus" 
                                   th:field="*{bonus}"
                                   step="1000"
                                   min="0">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="home" class="form-label">Home Allowance</label>
                        <select class="form-control addition-amount" 
                                id="home" 
                                th:field="*{home}">
                            <option value="0">No</option>
                            <option value="100000">Yes (+100,000 MMK)</option>
                        </select>
                    </div>
                        
                    <div class="col-md-3 mb-3">
                        <label for="businessTrip" class="form-label">Business Trip</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control addition-amount" 
                                   id="businessTrip" 
                                   th:field="*{businessTrip}"
                                   step="1000"
                                   min="0">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="continuedYear" class="form-label">Continued Year</label>
                        <div class="input-group">
                            <span class="input-group-text">Year</span>
                            <input type="number" 
                                   class="form-control addition-amount" 
                                   id="continuedYear" 
                                   th:field="*{continuedYear}"
                                   step="1"
                                   min="0">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="attendancePerfect" class="form-label">Perfect Attendance</label>
                        <select class="form-control addition-amount" 
                                id="attendancePerfect" 
                                th:field="*{attendancePerfect}">
                            <option value="0">No</option>
                            <option value="10000">Yes (+10,000 MMK)</option>
                        </select>
                    </div>
                    <div class="col-md-8 mb-3">
                        <div class="calculation-box">
                            <small class="text-muted">Total Additions</small>
                            <h4 class="mb-0 addition-amount" id="totalAdditionsDisplay">0 MMK</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 8. Other Adjustments -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-adjust me-2"></i>Other Adjustments
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="homeTownVisit" class="form-label">Home Town Visit</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="homeTownVisit" 
                                   th:field="*{homeTownVisit}"
                                   step="1000">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="manualAdjust" class="form-label">Manual Adjustment</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="manualAdjust" 
                                   th:field="*{manualAdjust}"
                                   step="1000">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="exchangeBenefit" class="form-label">Exchange Benefit</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="exchangeBenefit" 
                                   th:field="*{exchangeBenefit}"
                                   step="1000"
                                   min="0">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="travelFee" class="form-label">Travel Fee (Kyat)</label>
                        <div class="input-group">
                            <span class="input-group-text">MMK</span>
                            <input type="number" 
                                   class="form-control readonly-field" 
                                   id="travelFee" 
                                   th:field="*{travelFee}"
                                   readonly>
                        </div>
                        <div class="form-text">Auto: Transportation Fee Ã— Present Days</div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="summary-box">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <small class="opacity-75">Basic Salary</small>
                        <h4 id="summaryBasicSalary">0 MMK</h4>
                    </div>
                    <div class="col-md-3">
                        <small class="opacity-75">Total Deductions</small>
                        <h4 class="deduction-amount" id="summaryDeductions">0 MMK</h4>
                    </div>
                    <div class="col-md-3">
                        <small class="opacity-75">Total Additions</small>
                        <h4 class="addition-amount" id="summaryAdditions">0 MMK</h4>
                    </div>
                    <div class="col-md-3">
                        <small class="opacity-75">This Month Net Salary</small>
                        <h4 id="monthNetSalary">0 MMK</h4>
                    </div>
                </div>
                <hr class="opacity-50">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-0">Final Net Salary</h5>
                        <small class="opacity-75">After all adjustments</small>
                    </div>
                    <div class="col-md-6 text-end">
                        <h3 class="mb-0 text-white" id="finalNetSalary">0 MMK</h3>
                        <small class="opacity-75" id="finalWithTransport">0 MMK (with transport)</small>
                    </div>
                </div>
            </div>

            <!-- Hidden fields for calculations -->
            <input type="hidden" id="overtime" name="overtime" th:field="*{overtime}">
            <input type="hidden" id="allowance" name="allowance" th:field="*{allowance}">

            <!-- Form Actions -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-calculator me-2"></i> Calculate & Save Payroll
                </button>
                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetToInitial()">
                    <i class="fas fa-sync-alt me-2"></i> Recalculate
                </button>
                <a th:href="@{/payroll/manage}" class="btn btn-outline-danger btn-lg">
                    <i class="fas fa-times me-2"></i> Cancel
                </a>
            </div>
        </form>
    </div>

    <th:block layout:fragment="scripts">
        <script>
            // Band level basic salaries (in MMK)
            const BAND_SALARIES = {
                "Band1": 350000,
                "Band1+": 440000,
                "Band2": 550000,
                "Band3": 650000,
                "Band4": 750000,
                "Band5": 850000,
                "Band6": 1150000,
                "Band7": 1350000,
                "Band8": 1550000
            };

            let basicSalary = 0;
            let workingDays = 0;

            function getBandSalary(bandLevel) {
                return BAND_SALARIES[bandLevel] || 0;
            }

            // 1. Calculate Present Days
            function calculatePresentDays() {
                workingDays = parseInt(document.getElementById('workingDays').value) || 0;
                const leaveDays = parseInt(document.getElementById('leaveDays').value) || 0;
                const presentDays = Math.max(0, workingDays - leaveDays);
                
                document.getElementById('presentDays').value = presentDays;
                return presentDays;
            }

            // 2. Calculate Travel Fee
            function calculateTravelFee() {
                const presentDays = calculatePresentDays();
                const transportationFee = parseFloat(document.getElementById('employeeTransportationFee').value) || 0;
                const travelFee = presentDays * transportationFee;
                
                document.getElementById('travelFee').value = Math.round(travelFee);
                return travelFee;
            }

            // 3. Calculate Overtime Amount
            function calculateOvertimeAmount() {
                const overtimeHours = parseInt(document.getElementById('overtimeHours').value) || 0;
                if (overtimeHours === 0 || workingDays === 0 || basicSalary === 0) {
                    document.getElementById('overtimeAmountDisplay').textContent = formatCurrency(0);
                    document.getElementById('overtime').value = 0;
                    return 0;
                }
                
                // Assuming 8 working hours per day
                const hourlyRate = basicSalary / (workingDays * 8);
                const overtimeAmount = overtimeHours * hourlyRate;
                document.getElementById('overtimeAmountDisplay').textContent = formatCurrency(overtimeAmount);
                document.getElementById('overtime').value = Math.round(overtimeAmount);
                return overtimeAmount;
            }

            // 4. Calculate Service Allowance
            function calculateServiceAllowance() {
                const myanmarYears = parseInt(document.getElementById('myanmarYears').value) || 0;
                const gicjpYears = parseInt(document.getElementById('gicjpYears').value) || 0;
                
                let allowance = 0;
                
                // Myanmar service years
                if (myanmarYears >= 6) {
                    allowance += 90000;
                } else if (myanmarYears >= 1) {
                    allowance += myanmarYears * 15000;
                }
                
                // GICJP service years
                if (gicjpYears >= 6) {
                    allowance += 300000;
                } else if (gicjpYears >= 1) {
                    allowance += gicjpYears * 50000;
                }
                
                document.getElementById('serviceAllowanceDisplay').textContent = formatCurrency(allowance);
                return allowance;
            }

            // 5. Calculate Assignment & Management Allowance
            function calculateManagementAssignmentAllowance() {
                const assignmentLevel = document.getElementById('assignmentLevel').value;
                const managementLevel = document.getElementById('managementLevel').value;
                
                let allowance = 0;
                
                // Assignment allowance
                if (assignmentLevel === "Sub TL") allowance += 100000;
                else if (assignmentLevel === "TL") allowance += 200000;
                else if (assignmentLevel === "PL") allowance += 200000;
                else if (assignmentLevel === "Senior PL") allowance += 300000;
                
                // Management allowance
                if (managementLevel === "Sub Leader") allowance += 500000;
                else if (managementLevel === "Leader") allowance += 600000;
                else if (managementLevel === "Sub Manager") allowance += 700000;
                else if (managementLevel === "Manager") allowance += 1100000;
                
                document.getElementById('managementAssignmentAllowanceDisplay').textContent = formatCurrency(allowance);
                return allowance;
            }

            // 6. Calculate Total Basic Allowance
            function calculateTotalBasicAllowance() {
                const educationAllowance = parseFloat(document.getElementById('educationAllowance').value) || 0;
                const evaluationAllowance = parseFloat(document.getElementById('evaluationAllowance').value) || 0;
                const japaneseJlptAllowance = parseFloat(document.getElementById('japaneseJlptAllowance').value) || 0;
                const japaneseNatAllowance = parseFloat(document.getElementById('japaneseNatAllowance').value) || 0;
                const englishAllowance = parseFloat(document.getElementById('englishAllowance').value) || 0;
                
                const total = educationAllowance + evaluationAllowance + 
                           japaneseJlptAllowance + japaneseNatAllowance + 
                           englishAllowance;
                
                document.getElementById('totalBasicAllowanceDisplay').textContent = formatCurrency(total);
                document.getElementById('allowance').value = Math.round(total);
                return total;
            }

            // 7. Calculate Leave Deduction
            function calculateLeaveDeduction() {
                const leaveDays = parseInt(document.getElementById('leaveDays').value) || 0;
                if (leaveDays === 0 || workingDays === 0) {
                    document.getElementById('leaveDeduction').value = 0;
                    return 0;
                }
                
                // Calculate daily rate: (Basic Salary + Total Basic Allowance) / Working Days
                const totalBasicAllowance = calculateTotalBasicAllowanceForLeaveDeduction();
                const dailyRate = (basicSalary + totalBasicAllowance) / workingDays;
                const deduction = leaveDays * dailyRate;
                
                document.getElementById('leaveDeduction').value = Math.round(deduction);
                return deduction;
            }

            // Helper function to calculate Total Basic Allowance for leave deduction
            function calculateTotalBasicAllowanceForLeaveDeduction() {
                const educationAllowance = parseFloat(document.getElementById('educationAllowance').value) || 0;
                const evaluationAllowance = parseFloat(document.getElementById('evaluationAllowance').value) || 0;
                const japaneseJlptAllowance = parseFloat(document.getElementById('japaneseJlptAllowance').value) || 0;
                const japaneseNatAllowance = parseFloat(document.getElementById('japaneseNatAllowance').value) || 0;
                const englishAllowance = parseFloat(document.getElementById('englishAllowance').value) || 0;
                
                return educationAllowance + evaluationAllowance + 
                    japaneseJlptAllowance + japaneseNatAllowance + 
                    englishAllowance;
            }

            // 8. Calculate Late Deduction
            function calculateLateDeduction() {
                const lateDays = parseInt(document.getElementById('lateDays').value) || 0;
                const deduction = lateDays * 500; // 500 MMK per late day
                document.getElementById('lateDeduction').value = Math.round(deduction);
                return deduction;
            }

            // 9. Calculate Total Deductions
            function calculateTotalDeductions() {
                const leaveDeduction = parseFloat(document.getElementById('leaveDeduction').value) || 0;
                const lateDeduction = parseFloat(document.getElementById('lateDeduction').value) || 0;
                const incomeTax = parseFloat(document.getElementById('incomeTax').value) || 0;
                const loanReturn = parseFloat(document.getElementById('loanReturn').value) || 0;
                const ssc = parseFloat(document.getElementById('ssc').value) || 0;
                const companyTrip = parseFloat(document.getElementById('companyTrip').value) || 0;
                
                const total = leaveDeduction + lateDeduction + incomeTax + loanReturn + ssc + companyTrip;
                document.getElementById('totalDeductionsDisplay').textContent = formatCurrency(total);
                document.getElementById('summaryDeductions').textContent = formatCurrency(total);
                return total;
            }

            // 10. Calculate Total Additions
            function calculateTotalAdditions() {
                const bonus = parseFloat(document.getElementById('bonus').value) || 0;
                const homeAllowance = parseFloat(document.getElementById('home').value) || 0;
                const businessTrip = parseFloat(document.getElementById('businessTrip').value) || 0;
                const continuedYear = parseFloat(document.getElementById('continuedYear').value) || 0;
                const attendancePerfect = parseFloat(document.getElementById('attendancePerfect').value) || 0;
                
                const total = bonus + homeAllowance + businessTrip + continuedYear + attendancePerfect;
                document.getElementById('totalAdditionsDisplay').textContent = formatCurrency(total);
                document.getElementById('summaryAdditions').textContent = formatCurrency(total);
                return total;
            }

            // 11. Calculate Month Net Salary (Salary after deduction)
            function calculateMonthNetSalary() {
                const totalBasicAllowance = calculateTotalBasicAllowance();
                const leaveDeduction = calculateLeaveDeduction();
                const lateDeduction = calculateLateDeduction();
                
                // Basic salary + total basic allowance - leave deduction - late deduction
                const monthNetSalary = basicSalary + totalBasicAllowance - leaveDeduction - lateDeduction;
                document.getElementById('monthNetSalary').textContent = formatCurrency(monthNetSalary);
                return monthNetSalary;
            }

            // 12. Calculate Final Net Salary
            function calculateFinalNetSalary() {
                const monthNetSalary = calculateMonthNetSalary();
                const totalAdditions = calculateTotalAdditions();
                const totalDeductions = calculateTotalDeductions();
                const homeTownVisit = parseFloat(document.getElementById('homeTownVisit').value) || 0;
                const manualAdjust = parseFloat(document.getElementById('manualAdjust').value) || 0;
                const exchangeBenefit = parseFloat(document.getElementById('exchangeBenefit').value) || 0;
                const travelFee = calculateTravelFee();
                const serviceAllowance = calculateServiceAllowance();
                const managementAssignmentAllowance = calculateManagementAssignmentAllowance();
                const overtimeAmount = calculateOvertimeAmount();
                
                // Final calculation
                let finalNetSalary = monthNetSalary;
                finalNetSalary += totalAdditions; // Add bonus, home, etc.
                finalNetSalary += serviceAllowance; // Add service allowance
                finalNetSalary += managementAssignmentAllowance; // Add assignment/management
                finalNetSalary += overtimeAmount; // Add overtime
                finalNetSalary += homeTownVisit + manualAdjust + exchangeBenefit; // Add other adjustments
                finalNetSalary -= (calculateTotalDeductions() - parseFloat(document.getElementById('leaveDeduction').value || 0) - parseFloat(document.getElementById('lateDeduction').value || 0)); // Subtract other deductions
                
                document.getElementById('finalNetSalary').textContent = formatCurrency(finalNetSalary);
                document.getElementById('finalWithTransport').textContent = formatCurrency(finalNetSalary + travelFee) + " (with transport)";
                
                return finalNetSalary;
            }

            // Main calculation function
            function calculateAll() {
                // Get band level and set basic salary
                const bandLevel = document.getElementById('bandLevel').value;
                basicSalary = getBandSalary(bandLevel);
                workingDays = parseInt(document.getElementById('workingDays').value) || 0;
                
                // Display basic salary
                document.getElementById('displayBasicSalary').textContent = formatCurrency(basicSalary);
                document.getElementById('summaryBasicSalary').textContent = formatCurrency(basicSalary);
                document.getElementById('bandBasicSalary').textContent = formatCurrency(basicSalary);
                
                // Calculate all components
                calculatePresentDays();
                calculateTravelFee();
                calculateOvertimeAmount();
                calculateServiceAllowance();
                calculateManagementAssignmentAllowance();
                calculateTotalBasicAllowance(); 
                calculateLeaveDeduction(); 
                calculateLateDeduction();
                calculateTotalDeductions();
                calculateTotalAdditions();
                calculateMonthNetSalary();
                calculateFinalNetSalary();
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US').format(Math.round(amount)) + ' MMK';
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Set up event listeners for all inputs
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('change', calculateAll);
                    input.addEventListener('input', calculateAll);
                });
                
                // Initial calculation
                calculateAll();
            });

            // Form validation
            document.querySelector('form')?.addEventListener('submit', function(e) {
                const monthYear = document.getElementById('monthYear').value;
                workingDays = parseInt(document.getElementById('workingDays').value) || 0;

                if (!monthYear || !workingDays) {
                    e.preventDefault();
                    alert('Please fill in all required fields (Month/Year, Working Days).');
                    return;
                }

                if (!confirm('Are you sure you want to save this payroll calculation?')) {
                    e.preventDefault();
                }
            });

            function resetToInitial() {
                const form = document.querySelector('form');
                if (form) {
                    form.reset(); 
                    calculateAll(); 
                }
                location.reload();
            }
        </script>
    </th:block>
</body>
</html>