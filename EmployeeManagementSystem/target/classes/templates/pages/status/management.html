<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard-layout}">
<head>
    <title>Employee Status Management</title>
    <style>
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .status-active { 
            background-color: #28a745; 
            color: white; 
        }
        .status-inactive { 
            background-color: #dc3545; 
            color: white; 
        }
        
        .stats-card {
            border: none;
            border-radius: 10px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .filter-tabs .nav-link {
            border-radius: 20px;
            margin-right: 5px;
            padding: 8px 20px;
            border: 1px solid #dee2e6;
            color: #495057;
        }
        .filter-tabs .nav-link:hover {
            background-color: #f8f9fa;
        }
        .filter-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        .quick-action-btn {
            margin-bottom: 8px;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }
        
        .salary-positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .salary-zero {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div layout:fragment="dashboard-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">
                    <i class="fas fa-user-check me-2"></i>
                    Employee Status Management
                </h4>
                <p class="text-muted mb-0">Manage employee active/inactive status for salary processing</p>
            </div>
            <div>
                <a th:href="@{/status/salary-summary}" class="btn btn-primary">
                    <i class="fas fa-chart-pie me-2"></i> Salary Summary
                </a>
            </div>
        </div>

        <!-- Status Statistics -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h5 class="text-white mb-1">Total Employees</h5>
                            <h2 class="text-white mb-0" th:text="${totalCount}">0</h2>
                            <small class="text-white-50">All registered employees</small>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-users stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h5 class="text-white mb-1">Active</h5>
                            <h2 class="text-white mb-0" th:text="${activeCount}">0</h2>
                            <small class="text-white-50">Eligible for salary</small>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-check stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h5 class="text-white mb-1">Inactive</h5>
                            <h2 class="text-white mb-0" th:text="${inactiveCount}">0</h2>
                            <small class="text-white-50">Not eligible for salary</small>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-slash stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Actions -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-7">
                        <h6 class="mb-3">
                            <i class="fas fa-filter me-2"></i>
                            Filter by Status:
                        </h6>
                        <div class="filter-tabs">
                            <ul class="nav nav-pills">
                                <li class="nav-item">
                                    <a class="nav-link" 
                                       th:href="@{/status?status=all}"
                                       th:classappend="${selectedStatus == 'all'} ? 'active' : ''">
                                        <i class="fas fa-users me-1"></i>
                                        All (<span th:text="${totalCount}">0</span>)
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                       th:href="@{/status?status=Active}"
                                       th:classappend="${selectedStatus == 'Active'} ? 'active' : ''">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Active (<span th:text="${activeCount}">0</span>)
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                       th:href="@{/status?status=Inactive}"
                                       th:classappend="${selectedStatus == 'Inactive'} ? 'active' : ''">
                                        <i class="fas fa-times-circle me-1"></i>
                                        Inactive (<span th:text="${inactiveCount}">0</span>)
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h6 class="mb-3">
                            <i class="fas fa-bolt me-2"></i>
                            Quick Actions:
                        </h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success quick-action-btn bulk-action" data-status="Active">
                                <i class="fas fa-check-circle me-2"></i> Bulk Activate
                            </button>
                            <button class="btn btn-danger quick-action-btn bulk-action" data-status="Inactive">
                                <i class="fas fa-ban me-2"></i> Bulk Deactivate
                            </button>
                            <button class="btn btn-primary quick-action-btn" onclick="window.exportStatusReport(); return false;">
                                <i class="fas fa-download me-2"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current View Info -->
        <div class="alert alert-info d-flex align-items-center mb-3" th:if="${selectedStatus}">
            <i class="fas fa-info-circle me-2 fs-5"></i>
            <span th:if="${selectedStatus == 'all'}">
                Showing all <strong th:text="${filteredCount}"></strong> employees.
                <span th:if="${activeCount > 0}" class="ms-2">
                    <span class="badge bg-success" th:text="${activeCount} + ' active'"></span>
                </span>
                <span th:if="${inactiveCount > 0}" class="ms-1">
                    <span class="badge bg-danger" th:text="${inactiveCount} + ' inactive'"></span>
                </span>
            </span>
            <span th:if="${selectedStatus == 'Active'}">
                Showing <strong th:text="${filteredCount}"></strong> active employee(s) eligible for salary processing.
            </span>
            <span th:if="${selectedStatus == 'Inactive'}">
                Showing <strong th:text="${filteredCount}"></strong> inactive employee(s) not eligible for salary.
            </span>
        </div>

        <!-- Employees Table -->
        <div class="card">
            <div class="card-header bg-white py-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Employee List
                        </h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">
                                Select All
                            </label>
                        </div>
                        <span class="badge bg-secondary" id="selectedCount">0 selected</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="40px">
                                    <i class="fas fa-check"></i>
                                </th>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Department</th>
                                <th>Current Status</th>
                                <th>Basic Salary</th>
                                <th>Net Salary</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="emp : ${employees}" 
                                th:classappend="${emp.status == 'Inactive'} ? 'table-light' : ''">
                                <td>
                                    <input type="checkbox" class="employee-checkbox" 
                                           th:value="${emp.id}" 
                                           th:data-name="${emp.full_name}"
                                           onchange="updateSelectedCount()">
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="employee-avatar me-3">
                                            <span th:text="${emp.full_name?.substring(0,1)?.toUpperCase()}"></span>
                                        </div>
                                        <div>
                                            <div th:text="${emp.full_name}" class="fw-bold"></div>
                                            <small class="text-muted" th:text="'EMP-' + ${emp.id}"></small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span th:text="${emp.position ?: 'N/A'}"></span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary" th:text="${emp.department ?: 'N/A'}"></span>
                                </td>
                                <td>
                                    <span th:classappend="'status-badge status-' + ${emp.status?.toLowerCase()}" 
                                          th:text="${emp.status ?: 'Active'}">
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${emp.salary != null and emp.salary > 0}" 
                                          class="salary-positive">
                                        <i class="fas fa-money-bill-wave text-success me-1"></i>
                                        <span th:text="${#numbers.formatDecimal(emp.salary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                    <span th:unless="${emp.salary != null and emp.salary > 0}" 
                                          class="salary-zero">
                                        <i class="fas fa-minus"></i> Not set
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${emp.netSalary != null and emp.netSalary != '0' and !#strings.isEmpty(emp.netSalary)}" 
                                          class="fw-bold text-primary">
                                        <i class="fas fa-coins me-1"></i>
                                        <span th:text="${#numbers.formatDecimal(emp.netSalary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                    <span th:unless="${emp.netSalary != null and emp.netSalary != '0' and !#strings.isEmpty(emp.netSalary)}" 
                                          class="salary-zero">
                                        <i class="fas fa-minus"></i> Pending
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <span th:text="${emp.date ?: 'N/A'}"></span>
                                        <br>
                                        <span th:text="${emp.time ?: ''}" class="small"></span>
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/status/update/{id}(id=${emp.id})}" 
                                           class="btn btn-outline-warning" 
                                           title="Update Status">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a th:href="@{/status/salary/{id}(id=${emp.id})}" 
                                           class="btn btn-outline-info" 
                                           title="View Salary Breakdown"
                                           th:if="${emp.salary != null and emp.salary > 0}">
                                            <i class="fas fa-chart-pie"></i>
                                        </a>
                                        <a th:href="@{/employees/details/{id}(id=${emp.id})}" 
                                           class="btn btn-outline-secondary" 
                                           title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${employees.empty}">
                                <td colspan="9" class="text-center py-5">
                                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                                    <h5 class="text-muted">No employees found</h5>
                                    <p class="text-muted mb-3">Try changing your filter or add a new employee</p>
                                    <a th:href="@{/employees/add}" class="btn btn-primary">
                                        <i class="fas fa-user-plus me-2"></i> Add Employee
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <nav aria-label="Employee table pagination" class="mt-4" th:if="${totalPages > 0}">
                        <ul class="pagination justify-content-center">
                            <!-- Previous button -->
                            <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                <a class="page-link" 
                                   th:href="@{/status(page=${currentPage - 1}, size=${pageSize}, status=${selectedStatus})}" 
                                   aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            
                            <!-- Page numbers -->
                            <li class="page-item" 
                                th:each="i : ${#numbers.sequence(0, totalPages - 1)}" 
                                th:classappend="${i == currentPage ? 'active' : ''}">
                                <a class="page-link" 
                                   th:href="@{/status(page=${i}, size=${pageSize}, status=${selectedStatus})}" 
                                   th:text="${i + 1}">1</a>
                            </li>
                            
                            <!-- Next button -->
                            <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                                <a class="page-link" 
                                   th:href="@{/status(page=${currentPage + 1}, size=${pageSize}, status=${selectedStatus})}" 
                                   aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    
                    <!-- Page info -->
                    <div class="text-center text-muted small mt-2">
                        <span th:text="|Showing ${totalElements == 0 ? 0 : (currentPage * pageSize + 1)} to ${currentPage * pageSize + employees.size()} of ${totalElements} entries|"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for bulk operations -->
    <form id="bulkUpdateForm" method="POST" th:action="@{/status/bulk-update}" style="display: none;">
        <input type="hidden" name="employeeIds" id="bulkEmployeeIds">
        <input type="hidden" name="newStatus" id="bulkNewStatus">
        <input type="hidden" name="reason" id="bulkReason" value="Bulk status update">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>

    <th:block layout:fragment="scripts">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            
            window.updateSelectedCount = function() {
                const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
                const count = checkboxes.length;
                const selectedCountEl = document.getElementById('selectedCount');
                if (selectedCountEl) {
                    selectedCountEl.textContent = count + ' selected';
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                const selectAllCheckbox = document.getElementById('selectAll');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('.employee-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = this.checked;
                        });
                        window.updateSelectedCount();
                    });
                }

                window.updateSelectedCount();
                
                const successMsg = /*[[${success}]]*/ null;
                if (successMsg) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: successMsg,
                        confirmButtonColor: '#667eea',
                        timer: 3000,
                        showConfirmButton: true
                    });
                }
                
                const errorMsg = /*[[${error}]]*/ null;
                if (errorMsg) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMsg,
                        confirmButtonColor: '#667eea'
                    });
                }
            });

            window.bulkUpdateStatus = function(status) {
                console.log('bulkUpdateStatus called with status:', status); 
                
                const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
                console.log('Selected checkboxes:', selectedCheckboxes.length); 
                
                if (selectedCheckboxes.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Selection',
                        text: 'Please select at least one employee.',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }

                const statusText = status === 'Active' ? 'activate' : 'deactivate';
                const employeeNames = Array.from(selectedCheckboxes).map(cb => cb.dataset.name).join(', ');
                
                Swal.fire({
                    title: `Confirm Bulk ${status === 'Active' ? 'Activation' : 'Deactivation'}`,
                    html: `Are you sure you want to <strong>${statusText}</strong> these employees?<br><br>
                        <div class="text-muted small" style="max-height: 200px; overflow-y: auto;">${employeeNames}</div>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: status === 'Active' ? '#28a745' : '#dc3545',
                    confirmButtonText: `Yes, ${statusText} them`,
                    cancelButtonText: 'Cancel',
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        const employeeIds = Array.from(selectedCheckboxes).map(cb => cb.value).join(',');
                        
                        document.getElementById('bulkEmployeeIds').value = employeeIds;
                        document.getElementById('bulkNewStatus').value = status;
                        
                        const csrfToken = document.querySelector('input[name="_csrf"]')?.value;
                        const csrfParameter = document.querySelector('input[name="_csrf"]')?.name || '_csrf';
                        
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = document.getElementById('bulkUpdateForm').action;
                        form.style.display = 'none';
                        
                        // Add form fields
                        const fields = {
                            'employeeIds': employeeIds,
                            'newStatus': status,
                            'reason': 'Bulk status update',
                            [csrfParameter]: csrfToken
                        };
                        
                        for (const [key, value] of Object.entries(fields)) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = value || '';
                            form.appendChild(input);
                        }
                        
                        document.body.appendChild(form);
                        form.submit();
                        
                        return false; 
                    }
                });
            }

            // Export status report
            window.exportStatusReport = function() {
                const statusElement = document.querySelector('[th\\:text="${selectedStatus}"]');
                const status = statusElement ? statusElement.textContent : 'all';
                
                const url = status && status !== 'all' 
                    ? `/status/export?status=${status}`
                    : '/status/export';
                
                window.location.href = url;
                
                Swal.fire({
                    icon: 'success',
                    title: 'Export Started',
                    text: 'Your report is being downloaded.',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            document.addEventListener('DOMContentLoaded', function() {
                const activateBtn = document.querySelector('button[onclick="bulkUpdateStatus(\'Active\')"]');
                const deactivateBtn = document.querySelector('button[onclick="bulkUpdateStatus(\'Inactive\')"]');
                
                if (activateBtn) {
                    activateBtn.onclick = function(e) {
                        e.preventDefault();
                        window.bulkUpdateStatus('Active');
                    };
                }
                
                if (deactivateBtn) {
                    deactivateBtn.onclick = function(e) {
                        e.preventDefault();
                        window.bulkUpdateStatus('Inactive');
                    };
                }
            });

            document.querySelectorAll('.bulk-action').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const status = this.dataset.status;
                    window.bulkUpdateStatus(status);
                });
            });
            
            /*]]>*/
        </script>
    </th:block>
</body>
</html>