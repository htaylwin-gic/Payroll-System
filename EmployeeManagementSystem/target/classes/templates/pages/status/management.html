<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard-layout}">
<head>
    <title>Employee Status Management</title>
    <style>
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-leave { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-resigned { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        .status-terminated { background-color: #343a40; color: white; border: 1px solid #454d55; }
        
        .stats-card {
            border: none;
            border-radius: 10px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .filter-tabs .nav-link {
            border-radius: 20px;
            margin-right: 5px;
            padding: 8px 20px;
        }
        .filter-tabs .nav-link.active {
            background-color: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div layout:fragment="dashboard-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">Employee Status Management</h4>
                <p class="text-muted mb-0">Monitor and update employee employment status</p>
            </div>
            <div>
                <a th:href="@{/status/salary-summary}" class="btn btn-primary">
                    <i class="fas fa-chart-pie me-2"></i> Salary Summary
                </a>
            </div>
        </div>

        <!-- Status Statistics -->
        <div class="row mb-4">
            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                <div class="stats-card bg-primary">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Total</h5>
                            <h2 class="text-white" th:text="${employeeCount}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-users stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                <div class="stats-card bg-success">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Active</h5>
                            <h2 class="text-white" 
                                th:text="${employees.?[status == 'Active'].size()}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-check stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                <div class="stats-card bg-warning">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">On Leave</h5>
                            <h2 class="text-white" 
                                th:text="${employees.?[status == 'On Leave'].size()}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-bed stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                <div class="stats-card bg-secondary">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Inactive</h5>
                            <h2 class="text-white" 
                                th:text="${employees.?[status == 'Inactive'].size()}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-slash stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                <div class="stats-card bg-info">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Resigned</h5>
                            <h2 class="text-white" 
                                th:text="${employees.?[status == 'Resigned'].size()}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-sign-out-alt stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                <div class="stats-card bg-dark">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Terminated</h5>
                            <h2 class="text-white" 
                                th:text="${employees.?[status == 'Terminated'].size()}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-ban stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">Filter by Status:</h6>
                        <div class="filter-tabs">
                            <ul class="nav nav-pills">
                                <li class="nav-item">
                                    <a class="nav-link" th:href="@{/status}">
                                        All (<span th:text="${employeeCount}">0</span>)
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                    th:href="@{/status?status=Active}"
                                    th:classappend="${selectedStatus == 'Active'} ? 'active' : ''">
                                        Active
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                    th:href="@{/status?status=On Leave}"
                                    th:classappend="${selectedStatus == 'On Leave'} ? 'active' : ''">
                                        On Leave
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                    th:href="@{/status?status=Inactive}"
                                    th:classappend="${selectedStatus == 'Inactive'} ? 'active' : ''">
                                        Inactive
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                    th:href="@{/status?status=Resigned}"
                                    th:classappend="${selectedStatus == 'Resigned'} ? 'active' : ''">
                                        Resigned
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" 
                                    th:href="@{/status?status=Terminated}"
                                    th:classappend="${selectedStatus == 'Terminated'} ? 'active' : ''">
                                        Terminated
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-3">Quick Actions:</h6>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
                                <i class="fas fa-sync-alt me-2"></i> Bulk Update
                            </button>
                            
                            <a th:href="@{/status/export(status=${selectedStatus})}" class="btn btn-outline-success">
                                <i class="fas fa-file-export me-2"></i> Export Report
                            </a>
                            
                            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#notificationModal">
                                <i class="fas fa-bell me-2"></i> Send Notifications
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employees Table -->
        <div class="card">
            <div class="card-body">
                <form id="bulkActionForm" th:action="@{/status/bulk-action}" method="post">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Department</th>
                                <th>Current Status</th>
                                <th>Band Level</th>
                                <th>Basic Salary</th>
                                <th>Net Salary</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="emp : ${employees}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="employee-avatar me-3">
                                            <span th:text="${emp.full_name?.substring(0,1)?.toUpperCase()}"></span>
                                        </div>
                                        <div>
                                            <div th:text="${emp.full_name}" class="fw-bold"></div>
                                            <small class="text-muted" th:text="'EMP-' + ${emp.id}"></small>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${emp.position}"></td>
                                <td>
                                    <span class="badge bg-secondary" th:text="${emp.department}"></span>
                                </td>
                                <td>
                                    <span th:classappend="'status-badge status-' + ${emp.status?.toLowerCase()?.replace(' ', '-')}" 
                                        th:text="${emp.status ?: 'Not Set'}">
                                    </span>
                                </td>
                                <td th:text="${emp.bandLevel ?: 'N/A'}"></td>
                                <td>
                                    <span th:if="${emp.salary != null}">
                                        <span th:text="${#numbers.formatDecimal(emp.salary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${emp.netSalary != null}" class="fw-bold text-primary">
                                        <span th:text="${#numbers.formatDecimal(emp.netSalary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <span th:text="${emp.date ?: 'N/A'}"></span>
                                        <br>
                                        <span th:text="${emp.time ?: ''}"></span>
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/status/update/{id}(id=${emp.id})}" 
                                        class="btn btn-outline-warning" title="Update Status">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a th:href="@{/status/salary/{id}(id=${emp.id})}" 
                                        class="btn btn-outline-info" title="View Salary">
                                            <i class="fas fa-chart-pie"></i>
                                        </a>
                                        <a th:href="@{/employee/details/{id}(id=${emp.id})}" 
                                        class="btn btn-outline-secondary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${employees.empty}">
                                <td colspan="9" class="text-center py-5">
                                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted" th:if="${selectedStatus}">
                                        No employees found with status: <span th:text="${selectedStatus}"></span>
                                    </h5>
                                    <h5 class="text-muted" th:unless="${selectedStatus}">
                                        No employees found
                                    </h5>
                                    <a th:href="@{/employees/add}" class="btn btn-primary mt-2">
                                        <i class="fas fa-user-plus me-2"></i> Add Employee
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Status Distribution Chart -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="statusChart" height="250"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="mt-4">
                                    <div th:each="statusType : ${statusTypes}" class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span th:text="${statusType}"></span>
                                            <span class="fw-bold">
                                                <span th:text="${employees.?[status == statusType].size()}">0</span>
                                                (<span th:text="${employeeCount > 0 ? (employees.?[status == statusType].size() / employeeCount * 100) : 0}">0</span>%)
                                            </span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" 
                                                 th:classappend="'bg-' + ${statusType == 'Active' ? 'success' : 
                                                                 statusType == 'On Leave' ? 'warning' : 
                                                                 statusType == 'Inactive' ? 'secondary' : 
                                                                 statusType == 'Resigned' ? 'info' : 'dark'}"
                                                 th:style="'width: ' + ${employeeCount > 0 ? (employees.?[status == statusType].size() / employeeCount * 100) : 0} + '%'">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Quick Status Updates</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success" onclick="updateMultipleStatus('Active')">
                                <i class="fas fa-check-circle me-2"></i> Mark Selected as Active
                            </button>
                            <button class="btn btn-outline-warning" onclick="updateMultipleStatus('On Leave')">
                                <i class="fas fa-bed me-2"></i> Mark Selected as On Leave
                            </button>
                            <button class="btn btn-outline-secondary" onclick="updateMultipleStatus('Inactive')">
                                <i class="fas fa-user-slash me-2"></i> Mark Selected as Inactive
                            </button>
                            <button class="btn btn-outline-info" onclick="updateMultipleStatus('Resigned')">
                                <i class="fas fa-sign-out-alt me-2"></i> Mark Selected as Resigned
                            </button>
                            <button class="btn btn-outline-dark" onclick="updateMultipleStatus('Terminated')">
                                <i class="fas fa-ban me-2"></i> Mark Selected as Terminated
                            </button>
                        </div>
                        <hr>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">
                                Select All Employees
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chartData" 
             th:data-active-count="${employees.?[status == 'Active'].size()}"
             th:data-on-leave-count="${employees.?[status == 'On Leave'].size()}"
             th:data-inactive-count="${employees.?[status == 'Inactive'].size()}"
             th:data-resigned-count="${employees.?[status == 'Resigned'].size()}"
             th:data-terminated-count="${employees.?[status == 'Terminated'].size()}"
             style="display: none;">
        </div>
    </div>

    <div class="modal fade" id="bulkUpdateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Status Update</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/status/bulk-update}" method="post" id="bulkUpdateForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select Employees</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAllEmployees" onchange="toggleAllEmployees(this)">
                                <label class="form-check-label fw-bold" for="selectAllEmployees">
                                    Select All Visible Employees (<span th:text="${employeeCount}">0</span>)
                                </label>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px;">
                                <div th:each="emp : ${employees}" class="form-check mb-2">
                                    <input class="form-check-input employee-checkbox" type="checkbox" th:value="${emp.id}" th:id="'emp-' + ${emp.id}">
                                    <label class="form-check-label" th:for="'emp-' + ${emp.id}">
                                        <span th:text="${emp.full_name}"></span> 
                                        <small class="text-muted">(EMP-<span th:text="${emp.id}"></span>)</small>
                                    </label>
                                </div>
                                <div th:if="${employees.empty}" class="text-center text-muted py-3">
                                    No employees found
                                </div>
                            </div>
                            <!-- Hidden input to store selected IDs -->
                            <input type="hidden" name="employeeIds" id="selectedEmployeeIds">
                        </div>
                        
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">New Status *</label>
                            <select class="form-select" id="newStatus" name="newStatus" required>
                                <option value="">Select Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="On Leave">On Leave</option>
                                <option value="Resigned">Resigned</option>
                                <option value="Terminated">Terminated</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bulkReason" class="form-label">Reason (Optional)</label>
                            <textarea class="form-control" id="bulkReason" name="reason" rows="3" 
                                    placeholder="Enter reason for bulk status update..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This action will update the status for all selected employees.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Selected</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Send Notifications Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Status Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/status/send-notifications}" method="post" id="notificationForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select Recipients *</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="recipientType" id="allEmployees" value="all" checked>
                                <label class="form-check-label" for="allEmployees">
                                    All Employees (<span th:text="${employeeCount}">0</span>)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="recipientType" id="selectedEmployees" value="selected">
                                <label class="form-check-label" for="selectedEmployees">
                                    Selected Employees Only
                                </label>
                            </div>
                            
                            <!-- Hidden input for employee IDs -->
                            <input type="hidden" name="employeeIds" id="notificationEmployeeIds">
                        </div>
                        
                        <div class="mb-3">
                            <label for="notificationType" class="form-label">Notification Type</label>
                            <select class="form-select" id="notificationType" name="notificationType">
                                <option value="status_update">Status Update Notification</option>
                                <option value="monthly_report">Monthly Status Report</option>
                                <option value="important_announcement">Important Announcement</option>
                                <option value="custom">Custom Message</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="customMessageDiv" style="display: none;">
                            <label for="customMessage" class="form-label">Custom Message *</label>
                            <textarea class="form-control" id="customMessage" name="message" rows="4" 
                                    placeholder="Enter your custom message here..."></textarea>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Notifications will be sent via email to employees with valid email addresses.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Notifications</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script th:inline="javascript">

            const chartData = document.getElementById('chartData');
            
            // Initialize chart
            function initializeChart() {
                const ctx = document.getElementById('statusChart').getContext('2d');
                const statusData = {
                    labels: ['Active', 'On Leave', 'Inactive', 'Resigned', 'Terminated'],
                    datasets: [{
                        data: [
                            parseInt(chartData.dataset.activeCount) || 0,
                            parseInt(chartData.dataset.onLeaveCount) || 0,
                            parseInt(chartData.dataset.inactiveCount) || 0,
                            parseInt(chartData.dataset.resignedCount) || 0,
                            parseInt(chartData.dataset.terminatedCount) || 0
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#6c757d',
                            '#17a2b8',
                            '#343a40'
                        ]
                    }]
                };
                new Chart(ctx, {
                    type: 'doughnut',
                    data: statusData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // ========== BULK UPDATE FUNCTIONS ==========
            function toggleAllEmployees(checkbox) {
                const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
                employeeCheckboxes.forEach(cb => {
                    cb.checked = checkbox.checked;
                });
                updateSelectedEmployeeIds();
            }

            function updateSelectedEmployeeIds() {
                const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value).join(',');
                const hiddenInput = document.getElementById('selectedEmployeeIds');
                if (hiddenInput) {
                    hiddenInput.value = selectedIds;
                }
            }

            // Bulk Update form submission 
            document.getElementById('bulkUpdateForm')?.addEventListener('submit', function(e) {
                updateSelectedEmployeeIds();
                
                const selectedIds = document.getElementById('selectedEmployeeIds')?.value || '';
                const newStatus = document.getElementById('newStatus')?.value;
                
                if (!selectedIds || selectedIds.trim() === '') {
                    e.preventDefault();
                    alert('Please select at least one employee.');
                    return false;
                }
                
                if (!newStatus) {
                    e.preventDefault();
                    alert('Please select a new status.');
                    return false;
                }
                
                // Get count of selected employees
                const selectedCount = selectedIds.split(',').filter(id => id.trim() !== '').length;
                
                // Confirm bulk update
                if (!confirm(`Update ${selectedCount} employee(s) to "${newStatus}" status?`)) {
                    e.preventDefault();
                    return false;
                }
                
                // Show processing
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Updating...';
                submitBtn.disabled = true;
                
                return true;
            });

            // ========== NOTIFICATION FUNCTIONS ==========
            function updateNotificationEmployeeIds() {
                const selectedCheckboxes = document.querySelectorAll('.notification-employee-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value).join(',');
                const hiddenInput = document.getElementById('notificationEmployeeIds');
                if (hiddenInput) {
                    hiddenInput.value = selectedIds;
                }
            }

            function toggleRecipientSelection(radio) {
                const employeeSelection = document.getElementById('employeeSelection');
                if (radio.value === 'selected') {
                    if (employeeSelection) {
                        employeeSelection.style.display = 'block';
                    }
                    // Update IDs when switching to selected mode
                    updateNotificationEmployeeIds();
                } else {
                    if (employeeSelection) {
                        employeeSelection.style.display = 'none';
                    }
                    // Clear IDs when switching to all mode
                    const hiddenInput = document.getElementById('notificationEmployeeIds');
                    if (hiddenInput) {
                        hiddenInput.value = '';
                    }
                }
            }

            // Notification form submission
            document.getElementById('notificationForm')?.addEventListener('submit', function(e) {
                const notificationType = document.getElementById('notificationType')?.value || 'status_update';
                const customMessage = document.getElementById('customMessage')?.value || '';
                const recipientType = document.querySelector('input[name="recipientType"]:checked')?.value || 'all';
                
                // Update selected IDs if needed
                if (recipientType === 'selected') {
                    updateNotificationEmployeeIds();
                    const selectedIds = document.getElementById('notificationEmployeeIds')?.value || '';
                    
                    if (!selectedIds || selectedIds.trim() === '') {
                        e.preventDefault();
                        alert('Please select at least one employee to notify.');
                        return false;
                    }
                }
                
                if (notificationType === 'custom' && (!customMessage || customMessage.trim() === '')) {
                    e.preventDefault();
                    alert('Please enter a custom message.');
                    return false;
                }
                
                // Prepare confirmation message
                let message = 'Send ';
                if (notificationType === 'custom') {
                    message += 'custom message';
                } else {
                    message += notificationType.replace(/_/g, ' ') + ' notification';
                }
                
                message += ' to ';
                
                if (recipientType === 'all') {
                    const totalCount = /*[[${employeeCount}]]*/ 0;
                    message += `all ${totalCount} employees`;
                } else {
                    const selectedIds = document.getElementById('notificationEmployeeIds')?.value || '';
                    const selectedCount = selectedIds.split(',').filter(id => id.trim() !== '').length;
                    message += `${selectedCount} selected employee(s)`;
                }
                
                message += '?';
                
                if (!confirm(message)) {
                    e.preventDefault();
                    return false;
                }
                
                // Show processing
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Sending...';
                submitBtn.disabled = true;
                
                return true;
            });

            // Toggle custom message field
            document.getElementById('notificationType')?.addEventListener('change', function() {
                const customMessageDiv = document.getElementById('customMessageDiv');
                if (this.value === 'custom') {
                    if (customMessageDiv) {
                        customMessageDiv.style.display = 'block';
                    }
                } else {
                    if (customMessageDiv) {
                        customMessageDiv.style.display = 'none';
                    }
                }
            });

            // ========== QUICK ACTIONS FUNCTIONS ==========

            // Update multiple employees status (for quick action buttons)
            function updateMultipleStatus(status) {
                // Get all employee checkboxes in the table
                const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
                
                if (checkboxes.length === 0) {
                    alert('Please select at least one employee from the table.');
                    return;
                }
                
                const employeeIds = Array.from(checkboxes).map(cb => cb.value).join(',');
                
                if (confirm(`Update ${checkboxes.length} selected employee(s) to "${status}" status?`)) {
                    // Create a hidden form to submit
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/status/bulk-update';
                    form.style.display = 'none';
                    
                    const idsInput = document.createElement('input');
                    idsInput.type = 'hidden';
                    idsInput.name = 'employeeIds';
                    idsInput.value = employeeIds;
                    form.appendChild(idsInput);
                    
                    const statusInput = document.createElement('input');
                    statusInput.type = 'hidden';
                    statusInput.name = 'newStatus';
                    statusInput.value = status;
                    form.appendChild(statusInput);
                    
                    // Add CSRF token if needed
                    const csrfToken = document.querySelector('input[name="_csrf"]');
                    if (csrfToken) {
                        const csrfClone = csrfToken.cloneNode(true);
                        form.appendChild(csrfClone);
                    }
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            }

            // Get selected employees from checkboxes
            function getSelectedEmployees() {
                const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.value);
            }

            // Export status report 
            function exportStatusReport() {
                console.log('Export initiated via direct link');
            }

            function sendStatusNotifications() {
                const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
                notificationModal.show();
            }

            // Select all employees in the table
            document.getElementById('selectAll')?.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.employee-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedEmployeeIds();
            });

            // ========== INITIALIZATION ==========
            document.addEventListener('DOMContentLoaded', function() {
                initializeChart();
                
                document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectedEmployeeIds);
                });
                
                document.querySelectorAll('.notification-employee-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateNotificationEmployeeIds);
                });
                
                const recipientRadios = document.querySelectorAll('input[name="recipientType"]');
                recipientRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        toggleRecipientSelection(this);
                    });
                });
                
                updateSelectedEmployeeIds();
                updateNotificationEmployeeIds();
                
                // Initialize Bootstrap modals if not already initialized
                if (typeof bootstrap !== 'undefined') {
                    const bulkUpdateModal = document.getElementById('bulkUpdateModal');
                    const notificationModal = document.getElementById('notificationModal');
                    
                    if (bulkUpdateModal) {
                        new bootstrap.Modal(bulkUpdateModal);
                    }
                    
                    if (notificationModal) {
                        new bootstrap.Modal(notificationModal);
                    }
                }
                
                addCsrfTokenToForms();
            });

            // Helper function to add CSRF token to forms
            function addCsrfTokenToForms() {
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || 
                                document.querySelector('input[name="_csrf"]')?.value;
                
                if (csrfToken) {
                    const forms = document.querySelectorAll('form');
                    forms.forEach(form => {
                        if (!form.querySelector('input[name="_csrf"]')) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_csrf';
                            csrfInput.value = csrfToken;
                            form.appendChild(csrfInput);
                        }
                    });
                }
            }

            // ========== UTILITY FUNCTIONS ==========
            function bulkUpdateStatus() {
                const bulkUpdateModal = new bootstrap.Modal(document.getElementById('bulkUpdateModal'));
                bulkUpdateModal.show();
            }

            function exportStatusReportOld() {
                // Redirect to export endpoint
                const selectedStatus = /*[[${selectedStatus}]]*/ null;
                let exportUrl = '/status/export';
                if (selectedStatus) {
                    exportUrl += '?status=' + encodeURIComponent(selectedStatus);
                }
                window.location.href = exportUrl;
            }

            function sendStatusNotificationsOld() {
                const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
                notificationModal.show();
            }

            function showErrorModal(message) {
                alert('Error: ' + message); 
            }

            function showSuccessMessage(message) {
                const flashContainer = document.querySelector('.alert-container');
                if (flashContainer) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    flashContainer.appendChild(alertDiv);
                    
                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                } else {
                    alert('Success: ' + message);
                }
            }

        </script>
            
        <style>
            .employee-checkbox, .notification-employee-checkbox {
                margin-right: 8px;
                cursor: pointer;
            }
            
            .form-check-label {
                cursor: pointer;
                user-select: none;
            }
            
            .modal-body .form-check {
                padding-left: 0;
            }
            
            .modal-body .form-check-input {
                margin-top: 0.3rem;
                margin-right: 8px;
            }
            
            .status-option {
                cursor: pointer;
            }
            
            .employee-checkbox:checked + label {
                font-weight: bold;
            }
            
            #employeeSelection, #notificationEmployeeSelection {
                transition: all 0.3s ease;
            }
            
            .btn-processing {
                position: relative;
                color: transparent !important;
            }
            
            .btn-processing::after {
                content: '';
                position: absolute;
                left: 50%;
                top: 50%;
                width: 20px;
                height: 20px;
                margin-left: -10px;
                margin-top: -10px;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </th:block>
</body>
</html>