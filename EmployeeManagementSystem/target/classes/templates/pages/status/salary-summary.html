<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/dashboard-layout}">
<head>
    <title>Salary Summary</title>
    <style>
        .summary-card {
            border: none;
            border-radius: 10px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .department-card {
            border-left: 5px solid;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .salary-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .progress-thin {
            height: 8px;
            border-radius: 4px;
        }
        .chart-container {
            height: 300px;
            position: relative;
        }
        .employee-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }
        .mmk-currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #28a745;
        }
        .dept-it { background-color: #667eea; color: white; }
        .dept-hr { background-color: #28a745; color: white; }
        .dept-technical { background-color: #ffc107; color: #212529; }
        .dept-design { background-color: #17a2b8; color: white; }
        .dept-finance { background-color: #6c757d; color: white; }
        .dept-other { background-color: #343a40; color: white; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div layout:fragment="dashboard-content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">Salary Summary & Analytics</h4>
                <p class="text-muted mb-0">Comprehensive salary analysis across the organization</p>
            </div>
            <div>
                <button class="btn btn-primary me-2" onclick="printReport()">
                    <i class="fas fa-print me-2"></i> Print Report
                </button>
                <!-- Export Data button removed as requested -->
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-primary">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Total Employees</h5>
                            <h2 class="text-white" th:text="${totalEmployees}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-users summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            <span th:text="${activeEmployees}">0</span> active employees
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-success">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Monthly Salary</h5>
                            <h2 class="text-white mmk-currency" 
                                th:text="${#numbers.formatDecimal(totalMonthlySalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-money-bill-wave summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            Total monthly payroll
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-warning">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Average Salary</h5>
                            <h2 class="text-white mmk-currency" 
                                th:text="${#numbers.formatDecimal(averageSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-chart-line summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            Per employee per month
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="summary-card bg-info">
                    <div class="row">
                        <div class="col-8">
                            <h5 class="text-white">Active Employees</h5>
                            <h2 class="text-white" th:text="${activeEmployees}">0</h2>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-user-check summary-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            <span th:text="${totalEmployees > 0 ? #numbers.formatDecimal((activeEmployees * 1.0 / totalEmployees * 100), 1, 1) : 0}">0</span>% of workforce
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Department-wise Salary Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Department Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rangeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Stats Cards - Simplified -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Department Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Hardcoded department stats based on your data -->
                            <div class="col-md-4">
                                <div class="department-card" style="border-left-color: #667eea;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">IT</h6>
                                        <span class="badge bg-primary">5 employees</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">26.3% of total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="department-card" style="border-left-color: #28a745;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">HR</h6>
                                        <span class="badge bg-success">4 employees</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">21.1% of total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="department-card" style="border-left-color: #ffc107;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">Technical</h6>
                                        <span class="badge bg-warning text-dark">4 employees</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">21.1% of total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="department-card" style="border-left-color: #17a2b8;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">Design</h6>
                                        <span class="badge bg-info">3 employees</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">15.8% of total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="department-card" style="border-left-color: #6c757d;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">Finance</h6>
                                        <span class="badge bg-secondary">3 employees</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">15.8% of total</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Salary List -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Employee Salary Details</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search employees..." id="employeeSearch">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="salaryTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Band Level</th>
                                <th>Basic Salary</th>
                                <th>Net Salary</th>
                                <th>% of Avg.</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="emp : ${allEmployees}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="employee-avatar me-3">
                                            <span th:text="${emp.full_name != null ? emp.full_name.substring(0,1).toUpperCase() : ''}"></span>
                                        </div>
                                        <div>
                                            <div th:text="${emp.full_name}" class="fw-bold"></div>
                                            <small class="text-muted" th:text="'EMP-' + ${emp.id}"></small>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${emp.position}"></td>
                                <td>
                                    <!-- Simplified department badge with conditional classes -->
                                    <span th:if="${emp.department == 'IT'}" class="badge dept-it" th:text="${emp.department}">IT</span>
                                    <span th:if="${emp.department == 'HR'}" class="badge dept-hr" th:text="${emp.department}">HR</span>
                                    <span th:if="${emp.department == 'Technical'}" class="badge dept-technical" th:text="${emp.department}">Technical</span>
                                    <span th:if="${emp.department == 'Design'}" class="badge dept-design" th:text="${emp.department}">Design</span>
                                    <span th:if="${emp.department == 'Finance'}" class="badge dept-finance" th:text="${emp.department}">Finance</span>
                                    <span th:if="${emp.department != 'IT' and emp.department != 'HR' and emp.department != 'Technical' and emp.department != 'Design' and emp.department != 'Finance'}" 
                                          class="badge dept-other" th:text="${emp.department}">Other</span>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="${emp.status == 'Active'} ? 'bg-success' : 'bg-danger'"
                                        th:text="${emp.status ?: 'Active'}">
                                    </span>
                                </td>
                                <td th:text="${emp.bandLevel != null ? emp.bandLevel : 'N/A'}"></td>
                                <td class="salary-cell mmk-currency">
                                    <span th:if="${emp.salary != null and emp.salary > 0}">
                                        <span th:text="${#numbers.formatDecimal(emp.salary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                    <span th:unless="${emp.salary != null and emp.salary > 0}" class="text-muted">Not set</span>
                                </td>
                                <td class="salary-cell mmk-currency">
                                    <span th:if="${emp.netSalary != null and emp.netSalary != '' and emp.netSalary != '0'}">
                                        <span th:text="${#numbers.formatDecimal(emp.netSalary, 0, 'COMMA', 2, 'POINT')}"></span> MMK
                                    </span>
                                    <span th:unless="${emp.netSalary != null and emp.netSalary != '' and emp.netSalary != '0'}" class="text-muted">Pending</span>
                                </td>
                                <td>
                                    <span th:if="${emp.salary != null and emp.salary > 0 and averageSalary > 0}">
                                        <span th:text="${#numbers.formatDecimal((emp.salary / averageSalary * 100), 1, 1)}"></span>%
                                    </span>
                                    <span th:unless="${emp.salary != null and emp.salary > 0 and averageSalary > 0}" class="text-muted">N/A</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/status/salary/{id}(id=${emp.id})}" 
                                           class="btn btn-outline-info" title="View Breakdown">
                                            <i class="fas fa-chart-pie"></i>
                                        </a>
                                        <a th:href="@{/employees/edit/{id}(id=${emp.id})}" 
                                           class="btn btn-outline-warning" title="Edit Employee">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a th:href="@{/payroll/calculate/{employeeId}(employeeId=${emp.id})}" 
                                           class="btn btn-outline-primary" title="Calculate Payroll">
                                            <i class="fas fa-calculator"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="5" class="text-end"><strong>Totals/Averages:</strong></td>
                                <td class="salary-cell mmk-currency">
                                    <strong th:text="${#numbers.formatDecimal(totalMonthlySalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</strong>
                                </td>
                                <td class="salary-cell mmk-currency">
                                    <strong th:text="${#numbers.formatDecimal(totalMonthlySalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</strong>
                                </td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Salary Analysis -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Salary Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <small class="text-muted">Highest Salary</small>
                                <p class="mb-0 fw-bold mmk-currency" 
                                   th:text="${#numbers.formatDecimal(highestSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</p>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted">Lowest Salary</small>
                                <p class="mb-0 fw-bold mmk-currency" 
                                   th:text="${#numbers.formatDecimal(lowestSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</p>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted">Salary Range</small>
                                <p class="mb-0 fw-bold mmk-currency" 
                                   th:text="${#numbers.formatDecimal(highestSalary - lowestSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</p>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted">Median Salary</small>
                                <p class="mb-0 fw-bold mmk-currency" 
                                   th:text="${#numbers.formatDecimal(medianSalary, 0, 'COMMA', 2, 'POINT')} + ' MMK'">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2 mb-4">
                            <a th:href="@{/payroll/manage}" class="btn btn-outline-primary">
                                <i class="fas fa-calculator me-2"></i> Go to Payroll Management
                            </a>
                            <a th:href="@{/employees/manage}" class="btn btn-outline-success">
                                <i class="fas fa-users me-2"></i> Manage Employees
                            </a>
                            <a th:href="@{/status}" class="btn btn-outline-warning">
                                <i class="fas fa-chart-bar me-2"></i> View Status Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            function initializeCharts() {
                const deptLabels = ['IT', 'HR', 'Technical', 'Design', 'Finance'];
                const deptCounts = [5, 4, 4, 3, 3];
                const deptPercentages = [26.3, 21.1, 21.1, 15.8, 15.8];
                
                const deptSalaries = {
                    'IT': 8500000,
                    'HR': 4800000,
                    'Technical': 6800000,
                    'Design': 4500000,
                    'Finance': 5200000
                };

                const deptCtx = document.getElementById('departmentChart')?.getContext('2d');
                if (deptCtx) {
                    new Chart(deptCtx, {
                        type: 'bar',
                        data: {
                            labels: deptLabels,
                            datasets: [{
                                label: 'Total Salary (MMK)',
                                data: deptLabels.map(dept => deptSalaries[dept] || 0),
                                backgroundColor: [
                                    '#667eea', // IT
                                    '#28a745', // HR
                                    '#ffc107', // Technical
                                    '#17a2b8', // Design
                                    '#6c757d'  // Finance
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let value = context.raw;
                                            return 'Total: ' + value.toLocaleString() + ' MMK';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString() + ' MMK';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Range Chart (Department Distribution)
                const rangeCtx = document.getElementById('rangeChart')?.getContext('2d');
                if (rangeCtx) {
                    new Chart(rangeCtx, {
                        type: 'pie',
                        data: {
                            labels: deptLabels.map((dept, index) => `${dept} (${deptPercentages[index]}%)`),
                            datasets: [{
                                data: deptCounts,
                                backgroundColor: [
                                    '#667eea', // IT
                                    '#28a745', // HR
                                    '#ffc107', // Technical
                                    '#17a2b8', // Design
                                    '#6c757d'  // Finance
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        usePointStyle: true,
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            let value = context.raw || 0;
                                            let percentage = deptPercentages[context.dataIndex] || 0;
                                            return `${label}: ${value} employees (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            // Search functionality
            document.getElementById('employeeSearch')?.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#salaryTable tbody tr');
                
                rows.forEach(row => {
                    const employeeName = row.cells[0]?.textContent?.toLowerCase() || '';
                    const department = row.cells[2]?.textContent?.toLowerCase() || '';
                    const position = row.cells[1]?.textContent?.toLowerCase() || '';
                    
                    if (employeeName.includes(searchTerm) || department.includes(searchTerm) || position.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            function printReport() {
                window.print();
            }

            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeCharts();
            });
        </script>
        
        <style>
            @media print {
                .btn, .quick-actions, .input-group, .navbar, .sidebar {
                    display: none !important;
                }
                .card {
                    box-shadow: none !important;
                    border: 1px solid #ddd !important;
                }
            }
            .mmk-currency {
                color: #28a745;
                font-weight: 600;
            }
            .dept-it { background-color: #667eea; color: white; }
            .dept-hr { background-color: #28a745; color: white; }
            .dept-technical { background-color: #ffc107; color: #212529; }
            .dept-design { background-color: #17a2b8; color: white; }
            .dept-finance { background-color: #6c757d; color: white; }
            .dept-other { background-color: #343a40; color: white; }
        </style>
    </th:block>
</body>
</html>